# 文件

## 文件的管理与结构

### 文件的属性

文件名、标识符、类型（用户不可见）、位置、大小、创建时间、最近修改时间、文件所有者、保护信息等。

### 文件的逻辑结构

无结构文件：流式文件，没啥好说的。

有结构文件：记录式文件，每条记录有一个数据项作为关键字。根据各项记录的长度分为**定长记录**和**可变长记录**。

**顺序文件:**文件中的记录一个接一个地按顺序排列，记录可以使定长或可变长的，在物理上可以使顺序存储或**链式存储**。

- 链式存储：无法完成随机存储，只能一个一个找。
- 顺序存储
  - 可变长记录：无法实现随机
  - 定长记录：
    - 可以实现随机存储
    - 若采用串结构，无法快速找到某个关键字对应的记录
    - 采用顺序结构，可以快速找到某个关键字对应的记录

**索引文件**：***对于可变长记录文件，我们无法快速找到第i个记录，但是我们很多时候又需要用到这种文件接狗狗，因此可以建立一个索引表，记录这些记录的地址***

索引表本身是定长记录的顺序文件 ，按照上面的说法，是可以快速找到第i个记录对应的索引项的。一般用于对信息处理及时性要求比较高的场所。 

### 文件目录结构

单级目录结构：早期操作系统不支持多级目录，系统中只能建立一张目录表，每个文件占一个目录项。实现了按名存储，**但不允许文件重名**。

两级目录结构：分为主文件目录和用户文件目录，允许不同***用户***的目录中的文件重名。

**多级目录结构（树形目录结构）**：

- 不同目录下的文件可以重名

- 从根目录出发的路径称为绝对路径

- 缺点：不便于实现文件的共享

**无环图目录结构**：可以用不同的文件名指向同一个文件（或一个目录，此时为共享该目录下的所有文件），需要为每个共享结点设置一个共享计数器，记录有多少个地方在共享当前节点。用户提出删除结点的请求时，只是删除该用户的FCB，并使得共享计数器减一，只有当共享计数器的值为0时才会删除这个共享结点。

索引结点：除了文件名之外的所有信息都被放入索引节点中，每个文件对应一个索引节点，目录中质保函文件名和结点指针，那么每一个目录的长度可以大幅缩小，那么对应每一个磁盘块可以存放更多目录项，最终在检索文件时磁盘的I/O第次数会减少很多，**大大提高检索效率**。

### 文件的目录结构

**文件分配方式--连续分配：连续分配方式要求每个文件在磁盘上占有一组连续的块。**

- 支持顺序访问和直接访问（随机访问）
- **在连续读写的时候最快！**
- 不方便文件拓展，存储空间利用率低，会产生磁盘碎片  

**文件分配方式--链接分配**

- 隐式链接：目录中记录了文件存放的其实块号和结束块号，有时候会增加一个字符去表示文件的长度。
  - 除了文件的最后一个文件块之外，每个磁盘块中都会保存指向下一个盘块的指针，这些指针对用户是透明的。
  - 特点：
    - 只支持顺序访问，不支持随机访问
    - 查找效率很低，指针本身也会浪费一定的存储空间
    - 方便文件拓展，不会有碎片问题，外存利用率很高
- 显式链接：把用于链接文件各物理块的指针显式地存放在一张表中，即文件分配表。

 **文件的分配方式--索引分配：允许文件离散地分配在各个磁盘块中，系统会为每个文件建立一张索引表，索引表中记录了文件的各个逻辑块对应的物理块。**

- 索引表存放的磁盘块称为索引块，文件数据存放的磁盘块被称为数据块。

- 支持随机访问，文件拓展也相对容易实现。 

----

- 索引分配方式：
  - 索引链接：如果索引表太大，一个索引块装不下，那么可以将多个索引块链接起来存放。缺点是如果太长，就会极大降低查找效率。
  - 多层索引： 采用k层索引结构，且顶级索引表未调入内存，则访问一个数据块只需要K+1次读磁盘操作。 缺点是如果文件很小，仍然要读取k+1次
  - 混合索引：多种索引分配方式的结合。例如一个索引表中既包含直接地址索引，又包含一级简介索引，还包含两级简介索引。优点是对于小文件来书，访问一个数据块的读取磁盘次数更少。 

-----

 ### 文件存储空间的管理

空闲表法：

- 适用于连续分配
- 表中第一个元素为空闲盘的块号，第二个元素为从这一块盘开始的空闲盘的块数。
- 为了找到足够的磁盘块存储，可以采用首次适应、最佳适应、最坏适应等算法来决定腰围文件分配哪个区间。
- 回收磁盘空间，在空闲表中对相邻的表项，回收完毕后表的长度减一。

空闲链表法：

- 从链头开始检索，所没有合适的连续空闲块，也可以将不同盘区的盘块同时分配给一个文件，修改后需要及时修改链表指针和盘大小等相关信息。
- 回收：回收空间后生成一个新的元素，接在链表的最后

位视图法：

- 二进制表示，每个二进制位对应一个盘块
- ![image-20211005100207213](/Users/yangliwei/Library/Application Support/typora-user-images/image-20211005100207213.png)

- 这里可以看出来，通过字号y和位号x可以求出当前磁盘的盘块号
- 公式为 y*16+x（这里一行是16个，所以是乘以16）

成组链接法：基本不考

### 文件的基本操作

创建文件：Create系统调用。参数：空间、路径、文件名（默认包含后缀名称）

删除文件：Delete

打开文件：Open 

- 会将目录项中的信息复制到内存中的打开文件表中，可以根据内存中的打开文件表进行操作
- 每个用户都会有自己的打开文件表，系统中也有一张总的打开文件表
- 进程打开文件表中的特有属性：读写指针，访问权限
- 系统打开文件表中的特有属性：打开计数器

读文件：read。需要指明是哪个文件，还需要指明读入多少数据，指明读入的数据要放在内存的什么地方。

### 文件共享

硬链接共享：基于索引节点的共享。增加一个索引节点，用于表示链接到本索引节点上的用户目录项数，具体链接为，文件-》索引节点-》目标文件

软链接共享：基于符号链的共享。创建一个link类型的文件，存储文件的路径，以此连接到对应的文件。

### 文件保护

- 口令保护：为文件设置口令，用户请求访问该文件时需要提供口令
  - 口令一般存放在pcb或者索引节点中
  - 优点：空间和时间开销不大
  - 缺点：口令存放在系统中不够安全
- 加密保护
  - 使用密码进行加密
  - 优点：保密性强
  - 缺点：编码或译码操作需要花费一定时间
- 访问控制
  - 在每个问价你的FCB或索引节点中增加一个访问控制列表，记录各个用户对文件的访问权限，**详细可以参考windows的管理员权限**

### 文件系统的层次结构

![image-20211005145351176](/Users/yangliwei/Library/Application Support/typora-user-images/image-20211005145351176.png)

用户接口-文件目录系统-存取控制模块-逻辑文件系统-文件信息缓冲区-物理文件系统
